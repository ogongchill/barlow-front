name: Deploy

on:
  workflow_run:
    workflows: ["ì–´í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ"]
    types:
      - completed
    branches: [deploy, hotfix, issue/cd]
  push:
    branches: [issue/cd]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

    - name: 'Authenticate to Google Cloud'
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
        service_account: barlow-app-publish@barlow-app.iam.gserviceaccount.com
        token_format: access_token

#    - name: Download app-release.aab from artifacts
#      uses: actions/download-artifact@v4
#      with:
#        name: app-release
#        run-id: ${{ github.event.workflow_run.id }}
#        path: ./build-artifacts
#
    - name: Download latest CI artifact (app-release)
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # CI ì›Œí¬í”Œë¡œìš° ì´ë¦„ (ci.ymlì—ì„œ ì„¤ì •í•œ nameê³¼ ì¼ì¹˜í•´ì•¼ í•¨)
        CI_WORKFLOW="ì–´í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ"

        # ê°€ì¥ ìµœê·¼ ì„±ê³µí•œ CI ì‹¤í–‰ì˜ run id ì°¾ê¸°
        CI_RUN_ID=$(gh run list \
          --workflow "$CI_WORKFLOW" \
          --branch deploy \
          --status success \
          --limit 1 \
          --json databaseId \
          --jq '.[0].databaseId')

        echo "â„¹ï¸ Latest CI run id: $CI_RUN_ID"

        # í•´ë‹¹ runì˜ artifact ë‹¤ìš´ë¡œë“œ
        mkdir -p build-artifacts
        gh run download "$CI_RUN_ID" \
          --name app-release \
          --dir build-artifacts

        ls -lh build-artifacts
#
#    - name: Play Console ë‚´ë¶€í…ŒìŠ¤íŠ¸ ë°°í¬
#      uses: r0adkll/upload-google-play@v1
#      with:
#        serviceAccountJsonPlainText: ${{ steps.auth.outputs.credentials_json }}
#        packageName: com.barlow.front
#        releaseFile: build-artifacts/app-release.aab
#        track: internal
#        status: completed
    - name: Deploy to Play Store
      env:
        ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
        PACKAGE_NAME: com.barlow.front
        TRACK: internal
      run: |
        set -e
        
        echo "ğŸ“Œ 1. Create Edit"
        EDIT_ID=$(curl -s -X POST \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits" \
          | jq -r '.id')
        echo "Got editId: $EDIT_ID"
        
        echo "ğŸ“Œ 2. Upload AAB"
        UPLOAD_URL="https://androidpublisher.googleapis.com/upload/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID/bundles?uploadType=resumable"
        SESSION_URL=$(curl -s -X POST \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "X-Upload-Content-Type: application/octet-stream" \
          -H "Content-Type: application/octet-stream" \
          --data-binary @build-artifacts/app-release.aab \
          "$UPLOAD_URL" \
          -D - | grep -i location | awk '{print $2}' | tr -d '\r')
        
        # ì‹¤ì œ ì—…ë¡œë“œ (resumable session)
        curl -X PUT \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/octet-stream" \
          --data-binary @build-artifacts/app-release.aab \
          "$SESSION_URL"
        
        VERSION_CODE=$(curl -s -X GET \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID/bundles" \
          | jq -r '.bundles[0].versionCode')
        echo "Uploaded bundle versionCode: $VERSION_CODE"
        
        echo "ğŸ“Œ 3. Assign to Track"
        curl -s -X PUT \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{\"releases\": [{\"versionCodes\": [\"$VERSION_CODE\"], \"status\": \"completed\"}]}" \
          "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID/tracks/$TRACK"
        
        echo "ğŸ“Œ 4. Commit Edit"
        curl -s -X POST \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID:commit"
        
        echo "âœ… Deployment to $TRACK completed"