name: Deploy

on:
  workflow_run:
    workflows: ["ì–´í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ"]
    types:
      - completed
    branches: [main, hotfix, dev, release]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

    - name: 'Authenticate to Google Cloud'
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
        service_account: barlow-app-publish@barlow-app.iam.gserviceaccount.com
        token_format: access_token
        access_token_scopes: https://www.googleapis.com/auth/androidpublisher

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download artifact from triggering workflow
      if: github.event_name == 'workflow_run'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Triggered by run id: ${{ github.event.workflow_run.id }}"
        mkdir -p build-artifacts
        gh run download ${{ github.event.workflow_run.id }} \
          --name app-release \
          --dir build-artifacts

        ls -lh build-artifacts
    - name: Set Track by Branch
      id: set-track
      run: |
        case "${GITHUB_REF_NAME}" in
          main)
            echo "TRACK=production" >> $GITHUB_ENV
            ;;
          hotfix)
            echo "TRACK=internal" >> $GITHUB_ENV
            ;;
          dev)
            echo "TRACK=internal" >> $GITHUB_ENV
            ;;
          release)
            echo "TRACK=rc" >> $GITHUB_ENV
            ;;
          *)
            echo "TRACK=internal" >> $GITHUB_ENV
            ;;
        esac

    - name: Deploy to Play Store
      env:
        ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
        PACKAGE_NAME: com.barlow.front
      run: |
        set -e

        echo "ðŸ“Œ 1. Create Edit"
        EDIT_RESPONSE=$(curl -s -X POST \
        -H "Authorization: Bearer $ACCESS_TOKEN" \
        -H "Content-Type: application/json" \
        "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits")
        
        echo "Full response: $EDIT_RESPONSE"
         
        EDIT_ID=$(echo "$EDIT_RESPONSE" | jq -r '.id')
        echo "Got editId: $EDIT_ID"
        
        echo "ðŸ“Œ 2. Upload AAB"
        UPLOAD_URL="https://androidpublisher.googleapis.com/upload/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID/bundles?uploadType=resumable"
        
        SESSION_URL=$(curl -s -D - -o /dev/null \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "X-Upload-Content-Type: application/octet-stream" \
          -H "Content-Type: application/octet-stream" \
          -X POST "$UPLOAD_URL" \
          | grep -Fi Location | awk '{print $2}' | tr -d '\r')

        echo "Got session URL: $SESSION_URL"
        
        curl -X PUT \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/octet-stream" \
          --data-binary @build-artifacts/app-release.aab \
          "$SESSION_URL"
        
        VERSION_CODE=$(curl -s -X GET \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID/bundles" \
          | jq -r '.bundles | max_by(.versionCode) | .versionCode')
        echo "Uploaded bundle versionCode: $VERSION_CODE"
        
        echo "ðŸ“Œ 3. Assign to Track"
        curl -s -X PUT \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{\"releases\": [{\"versionCodes\": [\"$VERSION_CODE\"], \"status\": \"completed\"}]}" \
          "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID/tracks/$TRACK"
        
        echo "ðŸ“Œ 4. Commit Edit"
        curl -s -X POST \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID:commit"
        
        echo "âœ… Deployment to $TRACK completed"