name: GitHub ìƒíƒœ ìš”ì•½ ë° ë³€ê²½ ì•Œë¦¼

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST)
  issues:
    types: [opened, closed, edited]
  pull_request:
    types: [opened, closed, reopened]
  milestone:
    types: [created, closed, edited]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  report-status:
    runs-on: ubuntu-latest

    steps:
      - name: ì´ë²¤íŠ¸ ì¶”ì¶œ
        run: |
          echo "TITLE=${{ github.event.issue.title || github.event.pull_request.title || 'ìŠ¤ì¼€ì¤„ ì‹¤í–‰' }}" >> $GITHUB_ENV
          echo "URL=${{ github.event.issue.html_url || github.event.pull_request.html_url || github.event.compare || '' }}" >> $GITHUB_ENV
          echo "USER=${{ github.actor }}" >> $GITHUB_ENV

      - name: GraphQL ì¡°íšŒ
        run: |
          curl -s -H "Authorization: bearer ${{ secrets.GITHUB_TOKEN }}" -X POST -d '{
            "query": "query { 
              repository(owner: \"ogongchill\", name: \"barlow-front\") { 
                openIssues: issues(states: OPEN) { totalCount } 
                openPRs: pullRequests(states: OPEN) { totalCount } 
                milestones(first: 10, states: [OPEN]) { 
                  nodes { 
                    title 
                    dueOn 
                    issues { totalCount } 
                    closedIssues: issues(states: CLOSED) { totalCount } 
                  } 
                } 
              } 
            }"
          }' https://api.github.com/graphql > result.json

      - name: ì‘ë‹µ íŒŒì‹± ë° ë§ˆì¼ìŠ¤í†¤ í…Œì´ë¸” ìƒì„±
        run: |
          OPEN_ISSUES=$(jq '.data.repository.openIssues.totalCount' result.json)
          OPEN_PRS=$(jq '.data.repository.openPRs.totalCount' result.json)
          TIME=$(date '+%Y-%m-%d %H:%M')

          MILESTONES=$(jq -c '.data.repository.milestones.nodes[]' result.json)

          TABLE="ì´ë¦„               ì™„ë£Œìœ¨   ë‚¨ì€ì´ìŠˆ  ë§ˆê°ì¼\n---------------------------------------------"
          while read -r item; do
            TITLE=$(echo "$item" | jq -r '.title')
            DUE=$(echo "$item" | jq -r '.dueOn // "ì—†ìŒ"')
            TOTAL=$(echo "$item" | jq '.issues.totalCount // 0')
            CLOSED=$(echo "$item" | jq '.closedIssues.totalCount // 0')
            REMAIN=$((TOTAL - CLOSED))
            PERCENT=$(awk "BEGIN {if ($TOTAL == 0) print 0; else print int(($CLOSED/$TOTAL)*100)}")
            TABLE+="\n$(printf \"%-18s %3s%%       %2s       %s\" \"$TITLE\" \"$PERCENT\" \"$REMAIN\" \"$DUE\")"
          done <<< "$MILESTONES"

          echo "$TABLE" > milestone_table.txt
          echo "OPEN_ISSUES=$OPEN_ISSUES" >> $GITHUB_ENV
          echo "OPEN_PRS=$OPEN_PRS" >> $GITHUB_ENV
          echo "TIME=$TIME" >> $GITHUB_ENV

      - name: Slack ë©”ì‹œì§€ ì „ì†¡
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          MSG=$(cat milestone_table.txt)

          curl -X POST -H 'Content-type: application/json' --data "{
            \"blocks\": [
              { \"type\": \"header\", \"text\": { \"type\": \"plain_text\", \"text\": \"ğŸ“Š GitHub ì €ì¥ì†Œ ìƒíƒœ ë³´ê³ \" }},
              { \"type\": \"section\", \"text\": { \"type\": \"mrkdwn\", \"text\": \"ğŸ“… *ì‹œê°„:* $TIME\nğŸ”§ *íŠ¸ë¦¬ê±°:* ${{ github.event_name }} by \`${USER}\`\" }},
              { \"type\": \"section\", \"text\": { \"type\": \"mrkdwn\", \"text\": \"*ğŸ“Œ ë³€ê²½ ë‚´ìš©:* <${URL}|${TITLE}>\" }},
              { \"type\": \"divider\" },
              { \"type\": \"section\", \"text\": { \"type\": \"mrkdwn\", \"text\": \"ğŸ› *Open Issues:* $OPEN_ISSUES\nğŸ”§ *Open PRs:* $OPEN_PRS\" }},
              { \"type\": \"divider\" },
              { \"type\": \"section\", \"text\": { \"type\": \"plain_text\", \"text\": \"ğŸ“Œ ë§ˆì¼ìŠ¤í†¤ í˜„í™©\", \"emoji\": true }},
              { \"type\": \"section\", \"text\": { \"type\": \"mrkdwn\", \"text\": \"\`\`\`\n$MSG\n\`\`\`\" }}
            ]
          }" $SLACK_WEBHOOK_URL
