name: GitHub ìƒíƒœ ìš”ì•½ ë° ë³€ê²½ ì•Œë¦¼

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST)
  issues:
    types: [opened, closed, edited]
  pull_request:
    types: [opened, closed, reopened]
  milestone:
    types: [created, closed, edited]
  push:
  workflow_dispatch:

jobs:
  report-status:
    runs-on: ubuntu-latest

    steps:
      - name: GraphQL ì¡°íšŒ
        run: |
          curl -s -H "Authorization: bearer ${{ secrets.GITHUB_TOKEN }}" -X POST -d '{
            "query": "query { repository(owner: \"ogongchill\", name: \"barlow-front\") { openIssues: issues(first: 10, states: OPEN, orderBy: {field: CREATED_AT, direction: DESC}) { nodes { title url } totalCount } openPRs: pullRequests(first: 10, states: OPEN, orderBy: {field: CREATED_AT, direction: DESC}) { nodes { title url } totalCount } milestones(first: 10) { nodes { title dueOn issues { totalCount } closedIssues: issues(states: CLOSED) { totalCount } } } } }"
          }' https://api.github.com/graphql > result.json

      - name: Slack ë©”ì‹œì§€ ì „ì†¡
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          TIME=$(date '+%Y-%m-%d %H:%M')
          OPEN_ISSUES=$(jq '.data.repository.openIssues.totalCount' result.json)
          OPEN_PRS=$(jq '.data.repository.openPRs.totalCount' result.json)
          RAW_TRIGGER=${GITHUB_EVENT_NAME:-unknown}
                    if [ "$RAW_TRIGGER" = "schedule" ]; then
            TRIGGER="ì•„ì¹¨ ì í˜¸"
          else
            TRIGGER="$RAW_TRIGGER"
          fi
          
          MILESTONES=$(jq -c '.data.repository.milestones.nodes[]' result.json)
          FIELDS=()
          while read -r item; do
            TITLE_FIELD=$(echo "$item" | jq -r '.title')
            
            DUE_RAW=$(echo "$item" | jq -r '.dueOn // empty')
            if [ -z "$DUE_RAW" ]; then
              DUE="ì—†ìŒ"
            else
              DUE=$(date -d "$DUE_RAW" '+%Y-%m-%d')
            fi
            
            TOTAL=$(echo "$item" | jq '.issues.totalCount // 0')
            CLOSED=$(echo "$item" | jq '.closedIssues.totalCount // 0')
          
            if [ "$TOTAL" -eq "$CLOSED" ] && [ "$TOTAL" -ne 0 ]; then
              continue  # ì™„ë£Œëœ ë§ˆì¼ìŠ¤í†¤ì€ ê±´ë„ˆëœ€
            fi
          
            REMAIN=$((TOTAL - CLOSED))
            PERCENT=$(awk -v total="$TOTAL" -v closed="$CLOSED" 'BEGIN { if (total == 0) print 0; else print int((closed / total) * 100) }')

            FIELD=$(jq -n --arg t "ğŸ“Œ *$TITLE_FIELD*" \
                           --arg p "*ì™„ë£Œìœ¨:* ${PERCENT}%" \
                           --arg r "*ë‚¨ì€ ì´ìŠˆ:* ${REMAIN}" \
                           --arg d "*ë§ˆê°ì¼:* ${DUE}" \
            '{
              type: "section",
              fields: [
                { type: "mrkdwn", text: $t },
                { type: "mrkdwn", text: "\($p)\n\($r)\n\($d)" }
              ]
            }')
            FIELDS+=("$FIELD")
          done <<< "$MILESTONES"
          
          # ğŸ‘‰ ë§ˆì¼ìŠ¤í†¤ì´ ëª¨ë‘ ì™„ë£Œë˜ì–´ FIELDSê°€ ë¹„ì—ˆì„ ê²½ìš° ë°©ì–´ ì²˜ë¦¬
          if [ ${#FIELDS[@]} -eq 0 ]; then
            FIELD=$(jq -n '{
            type: "section",
            text: { type: "mrkdwn", text: "ğŸ“Œ *ì§„í–‰ ì¤‘ì¸ ë§ˆì¼ìŠ¤í†¤ ì—†ìŒ*" }
            }')
              FIELDS+=("$FIELD")
          fi
            
          FIELDS_JSON=$(printf "%s\n" "${FIELDS[@]}" | jq -s '.')

          ### ì—´ë ¤ ìˆëŠ” PR ëª©ë¡
          PR_LIST=$(jq -r '.data.repository.openPRs.nodes[] | "- <\(.url)|\(.title)>"' result.json | paste -sd '\n' -)
          [ -z "$PR_LIST" ] && PR_LIST="ì—†ìŒ"
          ISSUE_LIST=$(jq -r '.data.repository.openIssues.nodes[] | "- <\(.url)|\(.title)>"' result.json | paste -sd '\n' -)
          [ -z "$ISSUE_LIST" ] && ISSUE_LIST="ì—†ìŒ"

          PAYLOAD=$(jq -n \
          --arg time "$TIME" \
          --arg open_issues "$OPEN_ISSUES" \
          --arg open_prs "$OPEN_PRS" \
          --arg pr_list "$PR_LIST" \
          --arg issue_list "$ISSUE_LIST" \
          --arg trigger "$TRIGGER" \
          --argjson fields "$FIELDS_JSON" '
          {
            blocks: (
              [
                { type: "header", text: { type: "plain_text", text: "ğŸ“Š GitHub ì €ì¥ì†Œ ìƒíƒœ ë³´ê³ " } },
                { type: "section", text: { type: "mrkdwn", text: "ğŸ•¹ï¸*íŠ¸ë¦¬ê±°:* \($trigger) at \($time) UTC"  } },
                { type: "section", text: { type: "mrkdwn", text: "ğŸ› *Open Issues:* \($open_issues)\nğŸ”§ *Open PRs:* \($open_prs)" } },
                { type: "divider" },
                { type: "section", text: { type: "plain_text", text: "âœ… ì—´ë¦° PR ëª©ë¡", emoji: true } },
                { type: "section", text: { type: "mrkdwn", text: $pr_list } },
                { type: "divider" },
                { type: "section", text: { type: "plain_text", text: "ğŸ ì—´ë¦° Issue ëª©ë¡", emoji: true } },
                { type: "section", text: { type: "mrkdwn", text: $issue_list } },
                { type: "divider" }
              ] + $fields
                      )
          }')

  
          echo "$PAYLOAD" | jq . # ë””ë²„ê¹… ì¶œë ¥

          curl -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$SLACK_WEBHOOK_URL"
